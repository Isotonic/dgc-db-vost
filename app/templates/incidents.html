{% extends 'base.html' %}
{% block css %}
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.20/css/dataTables.bootstrap4.min.css">
<link rel="stylesheet" type="text/css" href="/static/css/temp.css">
{% endblock %}
{% block heading %}
<a href="#newIncidentModal" data-toggle="modal" data-target="#newIncidentModal" class="btn btn-icon-split btn-success mb-1">
	<span class="btn-icon">
	<i class="fas fa-plus"></i>
	</span>
	<span class="text">New Incident</span>
</a>
{% endblock %}
{% block body %}
<div class="row">
	<div class="col-xl-3 col-md-6 mb-4">
		<div class="card border-left-primary shadow">
			<div class="card-body">
				<div class="row no-gutters align-items-center">
					<div class="col mr-2">
						<div class="text-s font-weight-bold text-primary text-uppercase mb-1">Total Incidents</div>
						<div class="h5 mb-0 font-weight-bold text-gray-800">{{ incidents|length }}</div>
					</div>
					<div class="col-auto">
						<div class="icon icon-shape bg-primary text-white rounded-circle shadow">
							<i class="fas fa-1fourx fa-clone"></i>
						</div>
					</div>
				</div>
				<p class="mt-3 mb-0 text-muted">
					<span class="text-{{ incidents_stat[0] }} mr-2"><i class="fa {% if incidents_stat[1] %}fa-{{ incidents_stat[1] }}{% endif %}"></i> {{ incidents_stat[2] }}</span>
					<span class="text-nowrap">since last hour</span>
				</p>
			</div>
		</div>
	</div>
	<div class="col-xl-3 col-md-6 mb-4">
		<div class="card border-left-warning shadow">
			<div class="card-body">
				<div class="row no-gutters align-items-center">
					<div class="col mr-2">
						<div class="text-s font-weight-bold text-warning text-uppercase mb-1">Response Time</div>
						<div class="h5 mb-0 font-weight-bold text-gray-800">1 Hour</div>
					</div>
					<div class="col-auto">
						<div class="icon icon-shape bg-warning text-white rounded-circle shadow">
							<i class="fas fa-1fourx fa-hourglass-end"></i>
						</div>
					</div>
				</div>
				<p class="mt-3 mb-0 text-muted">
					<span class="text-danger mr-2"><i class="fa fa-arrow-down"></i> 3.48%</span>
					<span class="text-nowrap">since last hour</span>
				</p>
			</div>
		</div>
	</div>
</div>
<div class="card shadow mb-4">
	<div class="card-header py-3">
		<h6 class="m-0 font-weight-bold text-primary">Incidents</h6>
	</div>
	<div class="card-body">
		<div class="table-responsive">
			<table class="table row-border" id="dataTable" width="100%" cellspacing="0">
				<thead>
					<tr>
						<th scope="col">
							Pinned
						</th>
						<th scope="col">
							Incident Title
						</th>
						<th scope="col">
							Location
						</th>
						<th scope="col">
							Priority
						</th>
						<th scope="col">
							Assigned To
						</th>
						<th scope="col">
							Tasks
						</th>
						<th scope="col">
							Last Updated
						</th>
						<th scope="col" class="d-none"></th>
					</tr>
				</thead>
				<tbody class="list">
					{% for incident in incidents %}
					<tr data-href="{{ url_for('view_incident', deployment_name=deployment.name, deployment_id=deployment.id, incident_name=incident.name, incident_id=incident.id) }}">
						<th scope="row">
							{% if current_user in incident.pinned %}
							<i class="fas fa-bookmark"></i>
							{% else %}
							<i class="far fa-bookmark"></i>
							{% endif %}
						</th>
						<td scope="row">
							{{ incident.name }}
						</td>
						<td scope="row">
							{{ incident.location }}
						</td>
						<td class="status">
							<span class="badge badge-dot mr-4">
							<i class="bg-warning"></i> {{ incident.get_priority() }}
							</span>
						</td>
						<td>
							{% if incident.assigned_to %}
							<div class="avatar-group">
								{% for user in incident.assigned_to %}
								<a href="#" class="avatar avatar-sm" data-toggle="tooltip"
									data-original-title="{{ user }}">
								<img alt="Avatar" src="{{ user.get_avatar() }}" class="rounded-circle avatar-sm">
								</a>
								{% endfor %}
							</div>
							{% else %}
							Unassigned
							{% endif %}
						</td>
						<td class="completion">
							<div class="d-flex align-items-center">
								{% set percentage = incident.calculate_task_percentage() %}
								{% if percentage == None %}
								None
								{% elif percentage == 100 %}
								Completed
								{% else %}
								<span class="mr-2">{{ percentage }}%</span>
								<div>
									<div class="progress">
										<div class="progress-bar bg-warning" role="progressbar" aria-valuenow="60"
											aria-valuemin="0" aria-valuemax="100"
											style="width: {{ percentage }}%;"></div>
									</div>
								</div>
								{% endif %}
							</div>
						</td>
						<td class="status">
							{{ moment(incident.last_updated).fromNow(refresh=True) }}
						</td>
						<td class="d-none">
							{{ incident.last_updated }}
						</td>
					</tr>
					{% endfor %}
				</tbody>
			</table>
		</div>
	</div>
</div>
{% endblock %}
{% block modals %}
<div class="modal fade" id="newIncidentModal" tabindex="-1" role="dialog" aria-labelledby="newIncidentModal" aria-hidden="true">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-body p-0">
				<div class="card shadow">
					<div class="card-header py-3 d-flex align-items-center justify-content-between">
						<h6 class="m-0 font-weight-bold text-primary">New Incident Report</h6>
						<button class="close" type="button" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">Ã—</span>
						</button>
					</div>
					<div class="card-body">
						<form id="newIncidentForm" method="post" role="form">
							<div class="form-group mb-3">
								<input class="form-control was-validated" name="name" placeholder="Incident Name" type="text" required>
							</div>
							<div class="form-group mb-3">
								<input class="form-control" name="location" placeholder="Location" type="text">
							</div>
							<textarea class="form-control" rows="3" name="description" placeholder="Description"></textarea>
							<div class="form-group mt-3 mb-3">
								<input class="form-control" name="reported_via" placeholder="Reported Via" type="text">
							</div>
							<div class="form-group mb-3">
								<input class="form-control" name="reference" placeholder="Reference (Optional)" type="text">
							</div>
							<div class="text-center">
								<button type="submit" class="btn btn-primary my-4">Submit</button>
							</div>
						</form>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
{% endblock %}
{% block scripts %}
<script src="https://cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.10.20/js/dataTables.bootstrap4.min.js"></script>
<script type="text/javascript" charset="utf-8">
	var deployment_id = {{ deployment.id }}
	var socket = io()

    socket.on("connect", function() {
        socket.emit("join", {'type': 1, 'deployment_id': deployment_id})
    })

	function recieve(data) {
		if (data['code'] == 200) {
			console.log(data)
			return true
		} else {
			console.log(data['code'] + ': ' + data['message'])
			return false
		}
	}

	$('#newIncidentForm').submit( function(e) {
	    e.preventDefault();
	    $('#newIncidentModal').modal('hide')
		socket.emit('create_incident', {'name': $(this).serializeArray()[0]['value'], 'location': $(this).serializeArray()[1]['value'], 'description': $(this).serializeArray()[2]['value'], 'reported_via': $(this).serializeArray()[3]['value'], 'reference': $(this).serializeArray()[4]['value'], 'deployment_id': deployment_id})
		$('#newIncidentForm').get(0).reset()
	})

	//TODO
	socket.on('create_incident', function(data) {
		return;
		if (recieve(data)) {
			$('#dataTable').DataTable().row.add([
            '<i class="far fa-bookmark"></i>',
            data['name'],
            data['location'],
            data['priority'],
            data['assigned_to'],
            data['tasks'],
            data['last_updated_timestamp'],
            data['last_updated']
        ] ).draw( false )
		}
	})

	$(document).on('click', 'td', function () {
	     window.location = $(this).parent().data("href")
	 })

</script>
<script>
	// Call the dataTables jQuery plugin
	$(document).ready(function() {
	    $('#dataTable').DataTable({
	      	"pageLength": 25,
	        "columnDefs": [
	            {   "targets": [ 0 ],
	                "orderable": false,
	                "searchable": false
	            },
	            {
	                "targets": [ 7 ],
	                "visible": false,
	                "searchable": false
	            },
	            {
	                "targets": [ 6 ],
	                "orderData": [ 7 ]
	
	            }
	        ],
	        "order": [
	            [ 6, "desc" ]
	        ]
	    });
	});
</script>
{% endblock %}