{% extends 'base.html' %}

{% block css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==" crossorigin=""/>
<link href='https://api.mapbox.com/mapbox-gl-js/v1.4.1/mapbox-gl.css' rel='stylesheet' />
{% endblock %}

{% block body %}
<div class="row">
<div class="col-xl-12">
    		<div class="card">

            <div class="card-header d-flex flex-row align-items-center justify-content-between">
				<h6 class="m-0 font-weight-bold text-primary">Map</h6>
            </div>
                <div class="row" style="">
                <div class="col-sm-3 overflow-auto pr-0">
        <div class="mb-4">
            {% for incident in deployment.incidents %}
            {% include 'map_card.html' %}
            {% endfor %}
        </div>
    </div>
    <div class="col-xl-9 col-lg-9 pl-0">
        <div id="Map" class="map-container"></div>
    </div>
                </div>
            </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js" integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew==" crossorigin=""></script>
<script src='https://api.mapbox.com/mapbox-gl-js/v1.4.1/mapbox-gl.js'></script>
<script>
$(document).ready(function() {
		  var map = L.map('Map').setView({lat: 55.872326, lng: -4.288094}, 15)
		  L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
			attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
			minZoom: 4,
			maxZoom: 22,
			id: 'mapbox/streets-v11',
			accessToken: '{{ config['MAPBOX_API_KEY'] }}'
		}).addTo(map);

        function clickZoom(e) {
            map.flyTo(e.latlng, 15, {
            animate: true,
            duration: 0.5
          })
        }

        function onEachFeature(feature, layer) {
            // does this feature have a property named popupContent?
            if (feature.properties && feature.properties.description) {
                layer.bindPopup(feature.properties.description);
            }
        }

        var incidents_geojson = {{ geojson | tojson }}

        var geojsonLayer = L.geoJSON(incidents_geojson, {
            onEachFeature: onEachFeature
        }).addTo(map).on('click', clickZoom)
        map.fitBounds(geojsonLayer.getBounds())

        $('.list-group-item.list-group-flush').click( function(e) {
		var incident = incidents[$(this).data('incident-id')]
		if (incident) {
            map.flyTo(L.latLng(incident[0], incident[1]), 15, {
            animate: true,
            duration: 0.5
          })
          }
	})
	})



</script>
{% endblock %}